FROM golang:1.24.0-alpine AS builder

# Pre-download Go binaries before building
# For airgapped deployment, these binaries should be pre-downloaded and copied
WORKDIR /prebuilt

# Option 1: Build from vendored source (preferred for airgap)
# Uncomment and add vendored source to build context
# COPY vendor/ /go/src/
# RUN cd /go/src/github.com/TBXark/mcp-proxy && go build -o /go/bin/mcp-proxy
# RUN cd /go/src/github.com/mark3labs/mcp-filesystem-server && go build -o /go/bin/mcp-filesystem-server

# Option 2: Copy pre-built binaries (for airgap)
# To use this option, pre-download the binaries and place them in the build context:
# - mcp-proxy (from https://github.com/TBXark/mcp-proxy/releases)
# - mcp-filesystem-server (from https://github.com/mark3labs/mcp-filesystem-server/releases)
# Then uncomment these lines:
# COPY mcp-proxy /go/bin/mcp-proxy
# COPY mcp-filesystem-server /go/bin/mcp-filesystem-server

# Fallback: Download from source (requires network, not true airgap)
RUN apk add --no-cache git && \
    go install github.com/TBXark/mcp-proxy@latest && \
    go install github.com/mark3labs/mcp-filesystem-server@latest

FROM alpine:3.19

RUN apk --no-cache add ca-certificates && \
    addgroup -S mcp && \
    adduser -S -G mcp mcp && \
    mkdir -p /app /data && \
    chown -R mcp:mcp /app /data

WORKDIR /app

COPY --from=builder /go/bin/mcp-proxy /usr/local/bin/
COPY --from=builder /go/bin/mcp-filesystem-server /usr/local/bin/

COPY config.json /app/config.json

USER mcp

ENTRYPOINT [ "mcp-proxy", "/app/config.json" ]

