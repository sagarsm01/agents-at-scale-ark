FROM python:3.12.9

WORKDIR /app

RUN groupadd -r executor && \
    useradd --system --uid 1001 --gid executor --home /home/executor executor && \
    mkdir -p /home/executor/.cache/uv && \
    chown -R executor:executor /home/executor

# Install uv via pip for airgapped compatibility
RUN pip install --no-cache-dir uv

# Copy project files
COPY pyproject.toml setup.cfg README.md ./
COPY src/ ./src/

# Copy ark-sdk wheel from build-context (created by build system)
COPY build-context/*.whl /tmp/

# Add ark-sdk wheel as dependency and sync
RUN uv add /tmp/ark_sdk-*.whl && \
    HOME=/home/executor uv sync --no-dev && \
    HOME=/home/executor uv pip install -e . && \
    chown -R executor:executor /home/executor && \
    chown -R executor:executor /app

USER executor

EXPOSE 8000

CMD [".venv/bin/executor-langchain"]

