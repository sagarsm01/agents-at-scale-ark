FROM python:3.12.9-slim

WORKDIR /app

# Install system dependencies and security updates
RUN adduser --system --uid 1001 --home /home/ark ark && \
  apt-get update && \
  apt-get upgrade -y libsqlite3-0 zlib1g libgnutls30 && \
  apt-get --no-install-recommends install -y curl && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/* && \
  mkdir -p /home/ark && \
  chown -R ark:nogroup /home/ark

# Install uv via pip for airgapped compatibility
RUN pip install --no-cache-dir uv

# Copy dependency files from ark-api subdirectory (created by sync-ark-sdk.sh)
COPY ark-api/pyproject.toml ark-api/uv.lock ./

# Copy wheel files
COPY ark-api/out/ark*.whl /tmp/wheels/

# Copy source code
COPY ark-api/src/ ./src/
COPY ark-api/tests/ ./tests/
COPY ark-api/*.py ./

# Add ark-sdk wheel as a dependency and sync all dependencies
RUN uv add file://$(ls /tmp/wheels/ark*.whl) && \
  uv sync --frozen

ENV HOME=/home/ark
ENV XDG_CACHE_HOME=/home/ark/.cache
RUN mkdir -p /home/ark/.cache/uv && \
    mkdir -p /app/src/ark_api.egg-info && \
    chown -R ark:nogroup /home/ark && \
    chown -R ark:nogroup /app

USER ark

# Expose the application port
EXPOSE 8000

CMD [".venv/bin/uvicorn", "ark_api.main:app", "--host", "0.0.0.0", "--port", "8000"]

